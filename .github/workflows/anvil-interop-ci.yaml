name: Anvil Interop CI

on:
  pull_request:
    paths:
      - 'l1-contracts/scripts/anvil-interop/**'
      - '.github/workflows/anvil-interop-ci.yaml'
  push:
    branches:
      - main
    paths:
      - 'l1-contracts/scripts/anvil-interop/**'
      - '.github/workflows/anvil-interop-ci.yaml'

jobs:
  test-anvil-interop:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Foundry (includes Anvil)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install foundry-zksync
        uses: ./.github/actions/install-zksync-foundry

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.8
          cache: yarn

      - name: Install root dependencies
        run: yarn

      - name: Install anvil-interop dependencies
        working-directory: l1-contracts/scripts/anvil-interop
        run: yarn install

      - name: TypeScript type check
        working-directory: l1-contracts/scripts/anvil-interop
        run: npx tsc --noEmit

      - name: Build TypeScript
        working-directory: l1-contracts/scripts/anvil-interop
        run: yarn build

      - name: Verify file structure
        working-directory: l1-contracts/scripts/anvil-interop
        run: |
          echo "Checking required files..."
          test -f index.ts || (echo "index.ts missing" && exit 1)
          test -f package.json || (echo "package.json missing" && exit 1)
          test -f tsconfig.json || (echo "tsconfig.json missing" && exit 1)
          test -d src || (echo "src directory missing" && exit 1)
          test -d config || (echo "config directory missing" && exit 1)
          test -f src/anvil-manager.ts || (echo "anvil-manager.ts missing" && exit 1)
          test -f src/deployer.ts || (echo "deployer.ts missing" && exit 1)
          test -f src/chain-registry.ts || (echo "chain-registry.ts missing" && exit 1)
          test -f src/gateway-setup.ts || (echo "gateway-setup.ts missing" && exit 1)
          test -f src/batch-settler.ts || (echo "batch-settler.ts missing" && exit 1)
          test -f src/types.ts || (echo "types.ts missing" && exit 1)
          test -f src/utils.ts || (echo "utils.ts missing" && exit 1)
          echo "✅ All required files present"

      - name: Verify configuration files
        working-directory: l1-contracts/scripts/anvil-interop
        run: |
          echo "Checking configuration files..."
          test -f config/anvil-config.json || (echo "anvil-config.json missing" && exit 1)
          test -f config/l1-deployment.toml || (echo "l1-deployment.toml missing" && exit 1)
          test -f config/ctm-deployment.toml || (echo "ctm-deployment.toml missing" && exit 1)
          echo "✅ All configuration files present"

      - name: Validate JSON configuration
        working-directory: l1-contracts/scripts/anvil-interop
        run: |
          echo "Validating JSON configuration..."
          node -e "JSON.parse(require('fs').readFileSync('config/anvil-config.json', 'utf-8'))"
          echo "✅ JSON configuration valid"

      - name: Check Anvil availability
        run: |
          which anvil || (echo "Anvil not found in PATH" && exit 1)
          anvil --version
          echo "✅ Anvil is available"

      - name: Check Forge availability
        run: |
          which forge || (echo "Forge not found in PATH" && exit 1)
          forge --version
          echo "✅ Forge is available"

  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: test-anvil-interop
  
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Foundry (includes Anvil)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install foundry-zksync
        uses: ./.github/actions/install-zksync-foundry

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.8
          cache: yarn
  
      - name: Install dependencies
        run: yarn
  
      - name: Build da-contracts artifacts
        run: yarn da build:foundry
  
      - name: Build l1-contracts artifacts
        run: yarn l1 build:foundry
  
      - name: Build system-contract artifacts
        run: yarn sc build:foundry
  
      - name: Build l2-contracts artifacts
        run: yarn l2 build:foundry
  
      - name: Install anvil-interop dependencies
        working-directory: l1-contracts/scripts/anvil-interop
        run: yarn install
  
      - name: Start Anvil Interop Environment
        working-directory: l1-contracts/scripts/anvil-interop
        run: |
          yarn start &
          ANVIL_PID=$!
          sleep 60
          kill $ANVIL_PID || true
  
      - name: Check if chains started
        run: |
          echo "Checking L1 chain (port 9545)..."
          curl -f -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
            http://127.0.0.1:9545 || (echo "❌ L1 chain not responding on port 9545" && exit 1)

          echo "Checking L2 chain 10 (port 4050)..."
          curl -f -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
            http://127.0.0.1:4050 || (echo "❌ L2 chain 10 not responding on port 4050" && exit 1)

          echo "Checking L2 chain 11 (port 4051)..."
          curl -f -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
            http://127.0.0.1:4051 || (echo "❌ L2 chain 11 not responding on port 4051" && exit 1)

          echo "Checking L2 chain 12 (port 4052)..."
          curl -f -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
            http://127.0.0.1:4052 || (echo "❌ L2 chain 12 not responding on port 4052" && exit 1)

          echo "✅ All chains are responding"
