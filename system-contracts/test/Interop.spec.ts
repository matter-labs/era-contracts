// import * as hre from "hardhat";
import { expect } from "chai";
// import { Deployer } from "@matterlabs/hardhat-zksync-deploy";
import { ethers, network } from "hardhat";
import { defaultAbiCoder } from "ethers/lib/utils";
import type { Wallet } from "zksync-ethers";
// import * as zksyncV6 from "zksync-ethers-v6";
import * as zksync from "zksync-ethers";

import { serialize } from "zksync-ethers/build/utils";
import type { DefaultAccount } from "../typechain";
import { DefaultAccountFactory } from "../typechain";
import {
  TEST_BASE_TOKEN_SYSTEM_CONTRACT_ADDRESS,
  TEST_BOOTLOADER_FORMAL_ADDRESS,
  REAL_L2_INTEROP_HANDLER_ADDRESS,
  TEST_L2_ASSET_ROUTER_ADDRESS,
  INTEROP_BUNDLE_ABI,
  TEST_ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT_ADDRESS,
  REAL_L2_MESSAGE_VERIFICATION_ADDRESS,
  REAL_L2_INTEROP_ROOT_STORAGE_ADDRESS,
} from "./shared/constants";
import { signedTxToTransactionData } from "./shared/transactions";
import { deployContractOnAddress, getWallets } from "./shared/utils";
// import { ethers as ethersV5 } from "ethers";

// TODO: more test cases can be added.
describe("Interop tests", function () {
  let wallet: Wallet;
  let bootloaderAccount: ethers.Signer;

  let defaultAccount: DefaultAccount;
  let account: Wallet;
  const RANDOM_ADDRESS = ethers.utils.getAddress("0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef");

  before("Interop", async () => {
    wallet = getWallets()[0];
    account = getWallets()[2];
    await deployContractOnAddress(account.address, "DefaultAccount");
    defaultAccount = DefaultAccountFactory.connect(account.address, wallet);

    await deployContractOnAddress(TEST_ACCOUNT_CODE_STORAGE_SYSTEM_CONTRACT_ADDRESS, "AccountCodeStorage", false);

    await deployContractOnAddress(REAL_L2_INTEROP_HANDLER_ADDRESS, "DummyInteropHandler", false);

    await deployContractOnAddress(REAL_L2_MESSAGE_VERIFICATION_ADDRESS, "DummyL2MessageVerification", false);

    await deployContractOnAddress(REAL_L2_INTEROP_ROOT_STORAGE_ADDRESS, "L2InteropRootStorage", false);

    await deployContractOnAddress(TEST_BASE_TOKEN_SYSTEM_CONTRACT_ADDRESS, "L2BaseToken");
    // console.log("kl todo 6");
    await deployContractOnAddress(
      TEST_L2_ASSET_ROUTER_ADDRESS,
      "DummyL2AssetRouter",
      true,
      defaultAbiCoder.encode(
        ["uint256", "address", "address", "bytes32", "uint256"],
        [1, RANDOM_ADDRESS, RANDOM_ADDRESS, ethers.constants.HashZero, 1]
      )
    );

    bootloaderAccount = await ethers.getImpersonatedSigner(TEST_BOOTLOADER_FORMAL_ADDRESS);
  });

  it("successfully executed interop 1.5", async () => {
    // const hexTx =
    //   "0x71f91c8405840bebc200840bebc2008423c3460094000000000000000000000000000000000001000980b90ea0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005c00000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000001000d0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000800a0000000000000000000000000000000000000000000000000000000000008001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000300000000000000000000000000000000000000000000000000000000000100030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003249c884fd1000000000000000000000000000000000000000000000000000000000000010f0da2e607b35983d2ec75e38816c18f823db0015bdc7065e49e63526ed3dbfe15000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf0000000000000000000000008adcd7e93d2b402c92e3ef611ca52a4d780434fb000000000000000000000000550dde671fd8c05d217ba3ffa7375f600d80c17f000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c101000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000007546f6b656e204100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000006800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000001000d0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000800a0000000000000000000000000000000000000000000000000000000000008001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000300000000000000000000000000000000000000000000000000000000000100030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003249c884fd1000000000000000000000000000000000000000000000000000000000000010f0da2e607b35983d2ec75e38816c18f823db0015bdc7065e49e63526ed3dbfe15000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf0000000000000000000000008adcd7e93d2b402c92e3ef611ca52a4d780434fb000000000000000000000000550dde671fd8c05d217ba3ffa7375f600d80c17f000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c101000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000007546f6b656e20410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000241410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010010f000100000000000000000000000000000000000000000000000000000000f2502b72a0cb8a3e2798e8ac7c05dcdfd3c2a12544bbb5a9619bf00379894c615ded0fef81852eab61f6160e073806bebb560962fa5d614a552e42f218300cade3697c7f33c31a9b0f0aeb8542287d0d21e8c4cf82163d0c44c7a98aa11aa111199cc5812543ddceeddd0fc82807646a4899444240db2c0d2f20c3cceb5f51fae4733f281f18ba3ea8775dd62d2fcd84011c8c938f16ea5790fd29a03bf8db891798a1fd9c8fbb818c98cff190daa7cc10b6e5ac9716b4a2649f7c2ebcef227266d7c5983afe44cf15ea8cf565b34c6c31ff0cb4dd744524f7842b942d08770db04e5ee349086985f74b73971ce9dfe76bbed95c84906c5dffd96504e1e5396cac506ecb5465659b3a927143f6d724f91d8d9c4bdb2463aee111d9aa869874db124b05ec272cecd7538fdafe53b6628d31188ffb6f345139aac3c3c1fd2e470fc3be9cbd19304d84cca3d045e06b8db3acd68c304fc9cd4cbffe6d18036cb13ffef7bd9f889811e59e4076a0174087135f080177302763019adaf531257e3a87a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00bf6e093070e0389d2e529d60fadb855fdded54976ec50ac709e3a36ceaa64c291e4ed1ec13a28c40715db6399f6f99ce04e5f19d60ad3ff6831f098cb6cf75944820104808082010494000000000000000000000000000000000001000d820320c0b90d80000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf00000000000000000000000000000000000000000000000000000000000008600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000001000d0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000800a000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008adcd7e93d2b402c92e3ef611ca52a4d780434fb0000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf00000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000001000d0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000800a000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008adcd7e93d2b402c92e3ef611ca52a4d780434fb0000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf00000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010010f0001000000000000000000000000000000000000000000000000000000006e14c83984bf7a98c7443f92bd8a02dc01c9e62f79730e344c411ec8a16502765ded0fef81852eab61f6160e073806bebb560962fa5d614a552e42f218300cade3697c7f33c31a9b0f0aeb8542287d0d21e8c4cf82163d0c44c7a98aa11aa111199cc5812543ddceeddd0fc82807646a4899444240db2c0d2f20c3cceb5f51fae4733f281f18ba3ea8775dd62d2fcd84011c8c938f16ea5790fd29a03bf8db891798a1fd9c8fbb818c98cff190daa7cc10b6e5ac9716b4a2649f7c2ebcef227266d7c5983afe44cf15ea8cf565b34c6c31ff0cb4dd744524f7842b942d08770db04e5ee349086985f74b73971ce9dfe76bbed95c84906c5dffd96504e1e5396cac506ecb5465659b3a927143f6d724f91d8d9c4bdb2463aee111d9aa869874db124b05ec272cecd7538fdafe53b6628d31188ffb6f345139aac3c3c1fd2e470fc3be9cbd19304d84cca3d045e06b8db3acd68c304fc9cd4cbffe6d18036cb13ffef7bd9f889811e59e4076a0174087135f080177302763019adaf531257e3a87a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00bf6e093070e0389d2e529d60fadb855fdded54976ec50ac709e3a36ceaa64c291e4ed1ec13a28c40715db6399f6f99ce04e5f19d60ad3ff6831f098cb6cf7594400000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010008000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001040000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf000000000000000000000000000000000000000000000000000000000001000d39a2043688bb787ee7cf74d27211a5708748616513ce9dac0e17bdd1b072235667aa94840ae5cd8b080927ddad599bde72e56a4f3911df7043c808ce868c78ac00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000023c3460000000000000000000000000000000000000000000000000000000000000003200000000000000000000000001cc222598e0c44430e08bd3ea0f5a3bd8b210ddf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010010f00010000000000000000000000000000000000000000000000000000000072abee45b59e344af8a6e520241c4744aff26ed411f4c4b00f8af09adada43bad8f2e335ad06a7ca3fe043719eb330cfaf3945b6fb042559d0fa675b240c035de3697c7f33c31a9b0f0aeb8542287d0d21e8c4cf82163d0c44c7a98aa11aa111199cc5812543ddceeddd0fc82807646a4899444240db2c0d2f20c3cceb5f51fae4733f281f18ba3ea8775dd62d2fcd84011c8c938f16ea5790fd29a03bf8db891798a1fd9c8fbb818c98cff190daa7cc10b6e5ac9716b4a2649f7c2ebcef227266d7c5983afe44cf15ea8cf565b34c6c31ff0cb4dd744524f7842b942d08770db04e5ee349086985f74b73971ce9dfe76bbed95c84906c5dffd96504e1e5396cac506ecb5465659b3a927143f6d724f91d8d9c4bdb2463aee111d9aa869874db124b05ec272cecd7538fdafe53b6628d31188ffb6f345139aac3c3c1fd2e470fc3be9cbd19304d84cca3d045e06b8db3acd68c304fc9cd4cbffe6d18036cb13ffef7bd9f889811e59e4076a0174087135f080177302763019adaf531257e3a87a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00bf6e093070e0389d2e529d60fadb855fdded54976ec50ac709e3a36ceaa64c291e4ed1ec13a28c40715db6399f6f99ce04e5f19d60ad3ff6831f098cb6cf75944d694000000000000000000000000000000000000000080";
    // const legacyTx = await account.populateTransaction({
    //   type: 0,
    //   to: REAL_L2_INTEROP_HANDLER_ADDRESS,
    //   from: account.address,
    //   nonce: await account.getNonce(),
    //   data: "0x",
    //   value: 0,
    //   gasLimit: 50000,
    // });
    // const txBytes = await account.signTransaction(legacyTx);
    // const parsedTx = await zksync.utils.parseTransaction(txBytes);
    // const parsedTx2 = await zksyncV6.utils.parseEip712(txBytes);
    // const hexTx = zksync.utils.serialize(interopTx);
    // await broadcastTransaction(hexTx, account.provider);
    // await (account.provider as any).broadcastTransaction(hexTx);
  });

  // function calculateInteropTxData() {
  //   const interopTxString = ["tuple(address to, address from, bytes data, uint256 value)"];

  //   const paymasterBundle = defaultAbiCoder.encode(interopTxString, [
  //     { to: RANDOM_ADDRESS, from: account.address, data: RANDOM_ADDRESS, value: 10000000000000000000n },
  //   ]);
  //   const l2AssetRouterString =
  //     "0x9c884fd100000000000000000000000000000000000000000000000000000000000001109c0d4add1b94fd348199e854b0efbc68c1ec865016908282cfa32b5c02a69606000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000001a36f9dbffc50cd7c7d5ccec1ce3232d1f08280b0000000000000000000000008da7cffaf1eab3bce2817d0c20ef5cd7ce82455a00000000000000000000000060d16f709e9179f961d5786f8d035e337990971f0000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c1010000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004574254430000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000457425443000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000";
  //   const l2AssetRouterData = ethers.utils.arrayify(l2AssetRouterString);
  //   // console.log("kl todo l2AssetRouterData", l2AssetRouterData)
  //   // const call = defaultAbiCoder.encode(interopTxString, [
  //   //   { to: TEST_L2_ASSET_ROUTER_ADDRESS, from: TEST_L2_ASSET_ROUTER_ADDRESS, data: l2AssetRouterData, value: 0 },
  //   // ]);
  //   const executionBundle = defaultAbiCoder.encode(
  //     [INTEROP_BUNDLE_ABI],
  //     [
  //       {
  //         destinationChainId: 1,
  //         calls: [
  //           {
  //             to: TEST_L2_ASSET_ROUTER_ADDRESS,
  //             from: TEST_L2_ASSET_ROUTER_ADDRESS,
  //             data: l2AssetRouterData,
  //             value: 10000,
  //           },
  //         ],
  //         executionAddresses: [ethers.constants.AddressZero],
  //         cancellationAddress: ethers.constants.AddressZero,
  //       },
  //     ]
  //   );
  //   // console.log("kl todo executionBundle length", executionBundle.length)
  //   // console.log("kl todo executionBundle", executionBundle)
  //   interopTxData = defaultAbiCoder.encode(["bytes", "bytes"], [paymasterBundle, executionBundle]);
  //   // let [feeBytes, execBytes] = defaultAbiCoder.decode(["bytes", "bytes"], interopTxData)
  //   // console.log(feeBytes, execBytes)
  //   // const interopBundle = defaultAbiCoder.decode([INTEROP_BUNDLE_ABI], execBytes)
  //   // console.log(interopBundle)
  //   // console.log(interopBundle[0].executionAddresses)
  //   // console.log(interopBundle[0].calls)
  // }

  after(async function () {
    await network.provider.request({
      method: "hardhat_stopImpersonatingAccount",
      params: [TEST_BOOTLOADER_FORMAL_ADDRESS],
    });
  });

  //   it("successfully executed interop", async () => {
  //     const legacyTx = await account.populateTransaction({
  //       type: 0,
  //       to: TEST_L2_INTEROP_HANDLER_ADDRESS,
  //       from: account.address,
  //       nonce: 111,
  //       data: ethers.utils.arrayify(interopTxData),
  //       value: 0,
  //       gasLimit: 50000,
  //     });
  //     const txBytes = await account.signTransaction(legacyTx);
  //     const parsedTx = zksync.utils.parseTransaction(txBytes);
  //     const txData = signedTxToTransactionData(parsedTx)!;
  //     console.log(txData);

  //     const txHash = parsedTx.hash;
  //     delete legacyTx.from;
  //     const signedHash = ethers.utils.keccak256(serialize(legacyTx));

  //     await expect(await defaultAccount.connect(bootloaderAccount).executeTransaction(txHash, signedHash, txData));
  //     // .to.emit(TEST_L2_ASSET_ROUTER_ADDRESS, "Called")
  //     // .withArgs("0xdeadbeef");
  //   });

  it.skip("successfully executed interop 2", async () => {
    const data = ethers.arrayify(
      "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001f900000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000800a00000000000000000000000000000000000000000000000000000000000080010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000826bd95eac751efac2e72071688726559137f82a0000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001f900000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ba00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000007200000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000000800a000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000000000000000000000000002c68af0bb14000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000300000000000000000000000000000000000000000000000000000000000100030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003249c884fd1000000000000000000000000000000000000000000000000000000000000010fdf39940cb1a0afc5250040a5804f8ff7bc140ebf2e75f256e7c459012845b4a3000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000826bd95eac751efac2e72071688726559137f82a000000000000000000000000826bd95eac751efac2e72071688726559137f82a0000000000000000000000009a81a024873e01c4e337e044065016ac60eca97b000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c101000000000000000000000000000000000000000000000000000000000000010f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000007546f6b656e20410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000241410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c3fa32a3cb219b21aff6d019573f953447ed5d8000000000000000000000000826bd95eac751efac2e72071688726559137f82a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044095ea7b30000000000000000000000002a628cc3659a7c82a6c8ca1e9e933e1676cf3865000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000002a628cc3659a7c82a6c8ca1e9e933e1676cf3865000000000000000000000000826bd95eac751efac2e72071688726559137f82a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002494b918de000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000009a81a024873e01c4e337e044065016ac60eca97b000000000000000000000000826bd95eac751efac2e72071688726559137f82a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000000000000000000000000000000000000001000400000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010002000000000000000000000000826bd95eac751efac2e72071688726559137f82a00000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000022424fd57fb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000010f00000000000000000000000000000000000000000000000002c68af0bb14000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c9c3800000000000000000000000000000000000000000000000000000000000000320000000000000000000000000826bd95eac751efac2e72071688726559137f82a00000000000000000000000000000000000000000000000000000000000100030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000a101ef75419b62712bace2de51cafa88b81ac028336312b659447726542afa5d8f0d00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000826bd95eac751efac2e72071688726559137f82a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000"
    );
    // console.log(data)
    const [feeBytes, execBytes] = defaultAbiCoder.decode(["bytes", "bytes"], data);
    // console.log(feeBytes, execBytes);
    const interopBundle = defaultAbiCoder.decode([INTEROP_BUNDLE_ABI], execBytes);
    const feeBundle = defaultAbiCoder.decode([INTEROP_BUNDLE_ABI], feeBytes);
    // console.log("exec bundle", interopBundle);
    // console.log("feeBundle", feeBundle);
    // console.log("exec address", interopBundle[0].executionAddresses)
    // console.log("exec calls", interopBundle[0].calls);
    // console.log("fee calls", feeBundle[0].calls);
    const reencoded = defaultAbiCoder.encode([INTEROP_BUNDLE_ABI], interopBundle);
    const reencodedFee = defaultAbiCoder.encode([INTEROP_BUNDLE_ABI], feeBundle);
    // console.log(reencoded);
    const reencodedComplete = defaultAbiCoder.encode(["bytes", "bytes"], [reencodedFee, reencoded]);
    // console.log("reencoded", reencodedComplete);
    // console.log("number of calls", interopBundle[0].calls.length);
    for (const call of interopBundle[0].calls) {
      // console.log(call.from);
      const from = BigInt(0x1111000000000000000000000000000000000000) + BigInt(call.from) + BigInt(0x1111);
      // console.log("0x" + from.toString(16));
      await deployContractOnAddress("0x" + from.toString(16), "DefaultAccount");
    }

    const legacyTx = await account.populateTransaction({
      type: 0,
      to: REAL_L2_INTEROP_HANDLER_ADDRESS,
      from: account.address,
      nonce: await account.getNonce(),
      data: reencodedComplete,
      value: 0,
      gasLimit: 50000,
    });

    const txBytes = await account.signTransaction(legacyTx);
    const parsedTx = zksync.utils.parseTransaction(txBytes);
    const txData = signedTxToTransactionData(parsedTx)!;

    const txHash = parsedTx.hash;
    delete legacyTx.from;
    const signedHash = ethers.keccak256(serialize(legacyTx));

    await expect(await defaultAccount.connect(bootloaderAccount).executeTransaction(txHash, signedHash, txData));
  });
});

// async function broadcastTransaction(signedTx: string, provider: zksync.Provider): Promise<ethers.TransactionResponse> {
//   const { blockNumber, hash } = await ethersV5.utils.resolveProperties({
//     blockNumber: provider.getBlockNumber(),
//     hash: _perform(
//       {
//         method: "broadcastTransaction",
//         signedTransaction: signedTx,
//       },
//       provider
//     ),
//     network: provider.getNetwork(),
//   });

//   const tx = ethers.Transaction.from(signedTx);
//   if (tx.hash !== hash) {
//     throw new Error("@TODO: the returned hash did not match!");
//   }

//   // eslint-disable-next-line @typescript-eslint/no-explicit-any
//   return this._wrapTransactionResponse(<any>tx).replaceableTransaction(blockNumber);
// }

// eslint-disable-next-line @typescript-eslint/no-explicit-any
// async function _perform(req: ethers.PerformActionRequest, provider: zksync.Provider): Promise<any> {
//   // Legacy networks do not like the type field being passed along (which
//   // is fair), so we delete type if it is 0 and a non-EIP-1559 network
//   if (req.method === "call" || req.method === "estimateGas") {
//     const tx = req.transaction;
//     if (tx && tx.type != null && ethers.getBigInt(tx.type)) {
//       // If there are no EIP-1559 or newer properties, it might be pre-EIP-1559
//       if (tx.maxFeePerGas == null && tx.maxPriorityFeePerGas == null) {
//         const feeData = await provider.getFeeData();
//         if (feeData.maxFeePerGas == null && feeData.maxPriorityFeePerGas == null) {
//           // Network doesn't know about EIP-1559 (and hence type)
//           req = Object.assign({}, req, {
//             transaction: Object.assign({}, tx, { type: undefined }),
//           });
//         }
//       }
//     }
//   }

//   const request = {
//     method: "eth_sendRawTransaction",
//     args: [req.signedTransaction],
//   };

//   if (request != null) {
//     return await provider.send(request.method, request.args);
//   }

//   // return provider._perform(req);
// }
