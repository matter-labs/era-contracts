#!/bin/bash

set -e -o pipefail

readonly -a FILES_TO_PREPROCESS=(
  "contracts/bridge/asset-router/L2AssetRouter.sol"
  "contracts/bridge/L2SharedBridgeLegacy.sol"
)

on_exit() {
  git restore "${FILES_TO_PREPROCESS[@]}"
}
trap on_exit EXIT

# two-step instead one-step because MacOS sed uses -I but GNU sed uses -i
readonly TEMP_FILE="$(mktemp)"
for f in "${FILES_TO_PREPROCESS[@]}"; do
  sed -e 's/AddressAliasHelper.undoL1ToL2Alias(msg.sender) != L1_ASSET_ROUTER/false/' \
      -e 's/AddressAliasHelper.undoL1ToL2Alias(msg.sender) != l1SharedBridge/false/' \
     "$f" > "$TEMP_FILE"
  mv "$TEMP_FILE"   "$f"
done

case "$CONTEXT" in
  "L1")
    if [[ -n "$FOUNDRY_PROFILE" ]]; then
      :
    elif [[ "$GITHUB_ACTIONS" == "true" ]]; then
      export FOUNDRY_PROFILE="invariant_tests_l1context_ci"
    else
      export FOUNDRY_PROFILE="invariant_tests_l1context"
    fi

    forge test --match-path 'test/invariant/l1-context/*'
    ;;
  "L2")
    if [[ -n "$FOUNDRY_PROFILE" ]]; then
      :
    elif [[ "$GITHUB_ACTIONS" == "true" ]]; then
      export FOUNDRY_PROFILE="invariant_tests_l2context_ci"
    else
      export FOUNDRY_PROFILE="invariant_tests_l2context"
    fi

    forge clean
    forge test --match-path 'test/invariant/l2-context/*' --zksync
    ;;
  *)
    echo "error: CONTEXT environment variable must be set to either 'L1' or 'L2'" >&2
    exit 1
    ;;
esac
