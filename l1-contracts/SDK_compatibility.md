# SDK and contracts compatibility

## Shared Bridge upgrade

|                    | Old sdk                                                                                                                                                                                                                                                                        | Bridgehub SDK                                                                                                                                                                   |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| deposit            | L1ERC20 Bridge is called. This forwards the funds and the call to the depositLegacyErc20Bridge on the L1SharedBridge. We store depositAmount in ERC and depositHappened in SharedBridge. BH is called with requestL2TransactionDirect.                                         | Bridgehub requestL2Transaction(Direct/TwoBridges) is called, this calls bridgehubDeposit, bridgehubDepositBaseToken. We store the txHash in depositHappened.                    |
| finalizeWithdrawal | L1ERC20 Bridge is called. We check isWithdrawalFinalized in L1ERC20Bridge. We forward to L1SharedBridge. We check isWithdrawalFinalized and for legacy Eth Era withdrawals the Mailbox as well. We store isWithdrawalFinalized in L1SharedBridge.                              | L1SharedBridge is called. We check for legacy token and Eth Era withdrawals that the txs has not been finalized on the L1ERC20 and the Mailbox. We store isWithdrawalFinalized. |
| claimFailedDeposit | L1ERC20 Bridge is called. We check and delete depositAmount. L1SharedBridge is called, with checkedInLegacyBridge flag = true. We check and delete depositHappened if we can, i.e. if the deposit is not a legacy deposit ( legacy deposits never touched the L1SharedBridge). | L1SharedBridge is called, we check depositHappened and delete it.                                                                                                               |
| l2TokenAddress     | L1ERC20 Bridge is called.                                                                                                                                                                                                                                                      | L1ERC20 Bridge is called.                                                                                                                                                       |
| L2 withdrawal      | L1ERC20 Bridge is called                                                                                                                                                                                                                                                       | L1ERC20 Bridge is called                                                                                                                                                        |

## Custom Asset Bridging upgrade

We will finalize all legacy ( before the Bridgehub upgrade) withdrawals before the Custom Asset Bridging upgrade. This will cut complexity.

Note: in the first version the finalizeDeposit call to the L2SharedBridge is not updated for NTV assets to keep the SDK backwards compatible.

|                    | Old sdk                                                                                                                                                                                                                                                                                                                                                 | Bridgehub SDK                                                                                                                                                                               | Custom Asset Bridging                                                                                                                                           |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| deposit            | L1ERC20 Bridge is called. This forwards the funds and the call to the depositLegacyErc20Bridge on the L1SharedBridge. We store depositAmount in ERC and depositHappened in SharedBridge. Funds are further forwarded to NTV ( todo: do this directly from ERC20Bridge), and NTV is called to store funds. BH is called with requestL2TransactionDirect. | Bridgehub calls L1SharedBridge, AssetData encoding and token changed, L1SharedBridge can parse both                                                                                         | Bridgehub calls L1SharedBridge, AssetData encoding and token changed, L1SharedBridge can parse both                                                             |
| finalizeWithdrawal | L1ERC20 Bridge is called. We check isWithdrawalFinalized in L1ERC20Bridge. We forward to L1SharedBridge. We check the withdrawal is not legacy before the BH upgrade. We store isWithdrawalFinalized in L1SharedBridge.                                                                                                                                 | L1SharedBridge is called. We change token -> assetId. We check the withdrawal is not before the BH upgrade. We store isWithdrawalFinalized in L1SharedBridge. Forward to NTV to bridgeMint. | L1SharedBridge is called. We check the withdrawal is not before the BH upgrade. We store isWithdrawalFinalized in L1SharedBridge. Forward to NTV to bridgeMint. |
| claimFailedDeposit | L1ERC20 Bridge is called                                                                                                                                                                                                                                                                                                                                | L1SharedBridge is called                                                                                                                                                                    | L1SharedBridge is called                                                                                                                                        |
| l2TokenAddress     | L1ERC20 Bridge is called                                                                                                                                                                                                                                                                                                                                | L1ERC20 Bridge is called                                                                                                                                                                    | L1ERC20 Bridge is called                                                                                                                                        |
| L2 withdrawal      | L1ERC20 Bridge is called                                                                                                                                                                                                                                                                                                                                | L1SharedBridge is called                                                                                                                                                                    | L1SharedBridge is called                                                                                                                                        |
